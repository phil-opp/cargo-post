on: [push, pull_request]

name: Continuous integration

jobs:
  check:
    name: Build
    strategy:
      matrix:
        platform: [
          ubuntu-latest,
          macos-latest,
          windows-latest
        ]
    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v5
      - run: rustup update
      - run: cargo build

  test:
    name: Test Suite
    strategy:
      matrix:
        platform: [
          ubuntu-latest,
          macos-latest,
          windows-latest
        ]
    runs-on: ${{ matrix.platform }}
    steps:
      - uses: actions/checkout@v5
      - run: rustup update
      - run: cargo install --path . --debug
      - run: cargo post build --package simple
        working-directory: "tests/simple"
      - run: cargo post build --package dependency
        working-directory: "tests/dependency"
      - run: rustup target add x86_64-unknown-none
      - run: cargo post build --package cargo_config
        working-directory: "tests/cargo_config"
      - run: cargo post build --package cargo_build_target
        working-directory: "tests/cargo_build_target"
        env:
          CARGO_BUILD_TARGET: "x86_64-unknown-none"

  fmt:
    name: Rustfmt
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - run: rustup update
      - run: rustup component add rustfmt
      - run: cargo fmt --all -- --check

  clippy:
    name: Clippy
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v5
      - run: rustup update
      - run: rustup component add clippy
      - run: cargo clippy -- -D warnings
